<!DOCTYPE html>
<html ng-app = "app">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Enlace de Documentos</title>
  
  <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css" rel="stylesheet">
   
  <link rel="stylesheet" href="\node_modules\bootstrap\dist\css\bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
  <script src="\node_modules\bootstrap\dist\js\bootstrap.min.js"></script>
  <link href="\node_modules\bootstrap\dist\css\bootstrap-datetimepicker.min.css" rel="stylesheet">
  <script type="text/javascript"src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script> 
    <script type="text/javascript"src="\node_modules\bootstrap\dist\js\bootstrap-datetimepicker.min.js"></script>
	
    <!-- Angular--> 
	<script src="\node_modules\bootstrap\dist\js\angular.min.js"></script>
	
    </head>
    <body ng-app ng-controller = "ControllerAngular">
	  
	   
	<nav class="navbar navbar-default" style="background-color:#60161E;">
	<div class="container-fluid">
    <!-- REsponsive -->
    <div class="navbar-header" >
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="#"><span style="color:#FFFFFF;">SITUN</span></a>
    </div>

    <!-- Menu -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li ><a href="../../../../index.html"style="color:#FFFFFF;">Ingreso Correspondencia</span> </a></li>
        <li><a href="#"style="color:#FFFFFF;">Enlace Documentos</a></li>
        <li><a href="\node_modules\bootstrap\dist\paginas\Busqueda.html"style="color:#FFFFFF;">BÃºsqueda</a></li>
		<li><a href="#"style="color:#FFFFFF;">Reportes</a></li>
		<li><a href="#"style="color:#FFFFFF;">Escanear</a></li>
		<li><a href="#" style="color:#FFFFFF;">Pendientes</a></li>
		<li><a href="#" style="color:#FFFFFF;">Ayuda</a></li>
      </ul>
    
       		<IMG SRC="../../../../img/situn2.png" WIDTH=100 HEIGHT=100  class="nav navbar-nav navbar-right">
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
	  
	   
	   <!---Cuerpo--->
	   <body background="../../../../img/situn4.png">
	   
	   <table class ="table" style="border: hidden">
			<tr>
				<td width = 45%>
					<div class="col-md-1"></div>
					<div class="col-md-8">
						<span  class="text-danger"><h2>Enlace de Documentos</h2></span>
                      
						<form class="form-horizontal">
							<div class="form-group">
								<label class="col-sm-2 control-label  text-danger">Documento 1</label>
								
								<div class="col-sm-8">
								<input type="text" class = "form-control" id = "Documento1"  ng-model="doc1.tc_3" ng-Keypress = "buscar('Documento1')" ng-click="setCurrent(1)">
								</div>
							</div>
 
							<div class="form-group">
								<label class="col-sm-2 control-label  text-danger">Documento 2</label>
								<div class="col-sm-8">
									<input type="text" class="form-control" id="Documento2"  ng-model = "doc2.tc_3" ng-Keypress = "buscar('Documento2')" ng-click="setCurrent(2)">
								</div>
							</div>
						</form>
          
						<div class="col-sm-2">
							<input type = "button"class="btn btn-default" id ="guardar" value = "Realizar Enlace" ng-click = "enlazar()">
						</div>
						<div class="col-sm-3">
      
						</div>
						<div class="col-sm-2">
							<input type = "button" class="btn btn-default" id="cancelar" value = "Cancelar" onclick = "" >
						</div>	
					</div>						
				</td>
						
				<td></td>
				<td>
					<table class = "table table-bordered" id = "busqueda_enlace">
					
							<tr class="danger">
								<td></td>
								<td>Oficio</td>
								<td>Asunto</td>
								<td>Destinatario</td>
								<td>Remitente</td>
								</tr>
							
							<tbody>
								<tr ng-repeat = "c in correspondencias">
									<td> <button ng-click="updateDoc(c)"> + </button> </td>
									<td> {{c.tc_3 }} </td>
									<td> {{c.tc_8 }} </td>
									<td> {{c.tc_5 }} </td>
									<td> {{c.tc_7 }} </td>
								</tr>
							</tbody>
					</table>
				</td>
			</tr>
        </table>
		
	<div class="col-sm-3"	>
 <center><div class="date panel panel-danger "  style="background-color:#60161E;  margin-top:30px; color:white;" ></center><!-- div calendario----->
 </div>
<script src="../../../../bootstrap-datepicker.js"></script>	 	    
 <link rel="stylesheet" href="../../../../datepicker.css">
        <link rel="stylesheet" href="../../../../bootstrap.css"> 
		
		
		
<script type="text/javascript">
 document.addEventListener("DOMContentLoaded", pageLoad);
  
function pageLoad(){  //metodo para recuperar el id
	  let obj = JSON.parse(localStorage.getItem("user"));
	  let banderita = obj.bandera;
	  if ( banderita==true){
	  document.getElementById("Documento1").value=obj.numOficio;
	  localStorage.clear();
	  }
}

 $(document).ready(function () {
                
                $('.date').datepicker({
                    
                });
            
     });



	var app = angular.module('app', []);


function ControllerAngular($scope)
 {
	$scope.correspondencias = new Array();
	$scope.doc1;
	$scope.doc2;
	$scope.current;
	
	$scope.setCurrent = c => $scope.current = c;
	$scope.updateDoc = a => $scope.current == 1? $scope.doc1 = a : $scope.doc2 = a;
	
	$scope.updateCorrespondencias = c => $scope.correspondencias = c;
	$scope.buscar = a => busqueda(a,$scope);
	$scope.enlazar = _ => CrearEnlace($scope);
		
  }
  
   app.controller('ControllerAngular', ControllerAngular);
  
/*
 *	Realiza la busqueda en la base de datos de los elementos que coinciden
 *	parcialmente con el criterio, ya sea para el documento 1 o el 2 
 */
	function busqueda(id, $scope)
	{
		let h3 = document.getElementById(id).value.toUpperCase();
		id=="Documento1"? $scope.doc1 = null : $scope.doc2 = null ;
	
		fetch( 'http://localhost:3000/api/TC/BA', {  
			method: 'POST', 
			datatype:'json',
			headers: {  
				"Content-type": "application/x-www-form-urlencoded"  
			} ,
			body: "TC_8="+ h3
		})	 
		.then(res => res.json())
		.then(obj =>  
				$scope.$apply( _=>
					$scope.updateCorrespondencias(obj.data)) 
		)  
		.catch(err => console.log('Request failed', err));
	}
 
 /*
  *		Realiza el enlace de los documentos seleccionados
  */
  
	function CrearEnlace($scope){
		let a4 = $scope.doc1.tc_1;
		let b4 = $scope.doc2.tc_1;
		console.log(a4 , b4);
		fetch( 'http://localhost:3000/api/TD/I', {  
			method: 'POST', 
			datatype:'json',
			headers: {  
				"Content-type": "application/x-www-form-urlencoded"  
			} ,
			body: "TD_1="+ a4 + "&TD_2="+ b4
		}
		)
		.then(function(response) {
			return response.text().then(function(res) {
				console.log("Resultado: "+res);
			});
		})
		.catch(function(error) {  
			console.log('Request failed', error);  
		});
		}
  
    
</script>


    </body>
</html>
